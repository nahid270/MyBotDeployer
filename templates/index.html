<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Bot Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { background-color: #0f0f0f; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { background-color: #1f1f1f; border: 1px solid #333; box-shadow: 0 0 15px rgba(0,0,0,0.5); }
        .form-control { background-color: #2b2b2b; border: 1px solid #444; color: white; }
        .form-control:focus { background-color: #333; color: white; border-color: #0d6efd; }
        .table { color: #ccc; }
        .table-hover tbody tr:hover { background-color: #2a2a2a; }
        .btn-web { background-color: #0d6efd; color: white; }
        .btn-web:hover { background-color: #0b5ed7; color: white; }
        .modal-content { background-color: #1f1f1f; color: white; border: 1px solid #444; }
        .modal-header { border-bottom: 1px solid #333; }
        .modal-footer { border-top: 1px solid #333; }
    </style>
</head>
<body>

<div class="container mt-5">
    <h1 class="text-center mb-4 text-uppercase fw-bold" style="letter-spacing: 2px;">ü§ñ Ultimate Bot Manager</h1>

    <!-- Deploy Section -->
    <div class="card mb-5">
        <div class="card-header bg-dark text-info fw-bold">Deploy New Instance</div>
        <div class="card-body">
            <form action="/deploy" method="POST">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label text-secondary small">GitHub Repository</label>
                        <input type="text" name="repo_link" class="form-control" placeholder="https://github.com/username/repo" required>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label text-secondary small">Start File (Optional)</label>
                        <input type="text" name="start_file" class="form-control" placeholder="e.g. app.py">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label text-secondary small">Port (Optional)</label>
                        <input type="number" name="custom_port" class="form-control" placeholder="e.g. 5000">
                    </div>
                </div>
                
                <!-- Environment Variables Section -->
                <div class="mb-3">
                    <label class="form-label text-secondary small">Environment Variables / Config (String Session, URL, Token)</label>
                    <textarea name="env_vars" class="form-control font-monospace" rows="3" placeholder="STRING_SESSION=xyz...&#10;API_ID=12345&#10;API_HASH=abcdef..."></textarea>
                    <div class="form-text text-secondary">Enter each variable on a new line (KEY=VALUE).</div>
                </div>

                <button type="submit" class="btn btn-success w-100 fw-bold">‚ö° INITIATE DEPLOYMENT</button>
            </form>
        </div>
    </div>

    <!-- Active List -->
    <h4 class="mb-3 border-bottom pb-2">Active Instances</h4>
    <div class="table-responsive">
        <table class="table table-dark table-hover rounded overflow-hidden align-middle">
            <thead class="bg-secondary">
                <tr>
                    <th>Name</th>
                    <th>Port</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="bot-table-body">
                <tr><td colspan="4" class="text-center p-4">Loading system status...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Config Modal -->
<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚öôÔ∏è Edit Configuration</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-bot-name">
                <div class="mb-3">
                    <label class="form-label">Environment Variables</label>
                    <textarea id="edit-env-vars" class="form-control font-monospace" rows="6"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveConfig()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script>
    function updateStatus() {
        $.getJSON('/status', function(data) {
            let rows = '';
            if(data.length === 0) {
                rows = '<tr><td colspan="4" class="text-center text-secondary p-4">No bots deployed. Start one above!</td></tr>';
            } else {
                $.each(data, function(key, bot) {
                    let statusClass = bot.status.includes("Running") ? "text-success" : "text-warning";
                    if(bot.status.includes("Stopped") || bot.status.includes("Crashed")) statusClass = "text-danger";

                    let mainBtn = '';
                    let webBtn = '';

                    if (bot.running) {
                        mainBtn = `<a href="/stop/${bot.name}" class="btn btn-warning btn-sm fw-bold">üõë Stop</a>`;
                        webBtn = `<a href="/view/${bot.name}/" target="_blank" class="btn btn-web btn-sm fw-bold ms-1">üîó Open Web</a>`;
                    } else {
                        mainBtn = `<a href="/start/${bot.name}" class="btn btn-success btn-sm fw-bold">‚ñ∂Ô∏è Start</a>`;
                        webBtn = `<button class="btn btn-secondary btn-sm ms-1" disabled>üîó Web</button>`;
                    }
                    
                    rows += `
                    <tr>
                        <td class="fw-bold text-white">${bot.name}</td>
                        <td class="text-info font-monospace">${bot.port}</td>
                        <td class="${statusClass} fw-bold small">${bot.status}</td>
                        <td>
                            ${mainBtn}
                            ${webBtn}
                            <button class="btn btn-info btn-sm ms-1 fw-bold" onclick="openConfig('${bot.name}')">‚öôÔ∏è Config</button>
                            <a href="/delete/${bot.name}" class="btn btn-danger btn-sm ms-2">üóëÔ∏è</a>
                        </td>
                    </tr>`;
                });
            }
            $('#bot-table-body').html(rows);
        });
    }

    // ‡¶ï‡¶®‡¶´‡¶ø‡¶ó ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶ì‡¶™‡ßá‡¶® ‡¶ï‡¶∞‡¶æ
    function openConfig(botName) {
        $('#edit-bot-name').val(botName);
        $.getJSON('/get_config/' + botName, function(data) {
            $('#edit-env-vars').val(data.env);
            new bootstrap.Modal(document.getElementById('configModal')).show();
        });
    }

    // ‡¶ï‡¶®‡¶´‡¶ø‡¶ó ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ
    function saveConfig() {
        let botName = $('#edit-bot-name').val();
        let envData = $('#edit-env-vars').val();
        
        $.post('/update_config/' + botName, { env_vars: envData }, function(resp) {
            alert("Configuration Saved! Please Restart the bot.");
            $('#configModal').modal('hide'); // jQuery ‡¶¶‡¶ø‡ßü‡ßá ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶π‡¶æ‡¶á‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ (‡¶Ø‡¶¶‡¶ø ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü, bootstrap instance ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶π‡¶¨‡ßá)
             // ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ ‡¶≠‡¶æ‡¶≤‡ßã
             document.querySelector('#configModal .btn-close').click();
        });
    }

    setInterval(updateStatus, 2000);
    updateStatus();
</script>

</body>
</html>
